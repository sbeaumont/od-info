{% extends "odinfo-base.html" %}
{% block extrascripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.css" />
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/colreorder/1.7.0/js/dataTables.colReorder.min.js"></script>
<style>
    /* Fix ColVis dropdown to match w3-css dark theme */
    .dt-button-collection {
        background-color: #616161 !important; /* w3-dark-grey */
    }
    .dt-button-collection .dt-button {
        color: #fff !important;
        background: transparent !important;
    }
    .dt-button-collection .dt-button:hover {
        background-color: #000 !important; /* w3-black */
    }
    .dt-button-collection .dt-button.active {
        background-color: #000 !important; /* w3-black */
    }
    /* Sticky header that works with horizontal scrolling */
    #military_table thead th {
        position: sticky;
        top: 43px; /* Height of the top bar */
        background-color: #000 !important; /* w3-black */
        z-index: 2;
    }
</style>
{% endblock %}

{% block content %}
  <div class="w3-container">
    <!-- Column View Selector -->
    <div class="w3-panel w3-card-2 w3-dark-grey" style="margin-bottom: 10px; padding: 8px;">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <span><strong>Send Type:</strong></span>
            <label style="cursor: pointer;">
                <input type="radio" name="send_type" value="safe" checked> Normal Send
            </label>
            <label style="cursor: pointer;">
                <input type="radio" name="send_type" value="54"> 5/4 Send
            </label>
            <label style="cursor: pointer; margin-left: 20px;">
                <input type="checkbox" id="toggle-draftees"> Draftees
            </label>
            <label style="cursor: pointer;">
                <input type="checkbox" id="toggle-boats"> Boats
            </label>
            <span id="colvis-container" style="margin-left: 10px;"></span>
            <a href="#" id="reset-columns" style="font-size: 0.8em; color: #aaa;">reset</a>
            <label style="margin-left: 20px;">
                vs OP: <input type="number" id="versus-op" value="{{ versus_op or '' }}" placeholder="0" style="width: 70px; padding: 2px 4px;">
            </label>
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table id="military_table" class="w3-table w3-striped-dark w3-bordered w3-border w3-hoverable">
        <thead>
            <tr class="w3-black">
                <!-- Always visible -->
                <th>Dominion</th>
                <th>Realm</th>
                <th>Race</th>
                <th>Ops Age</th>
                <th>Land</th>
                <th>75%</th>
                <!-- Dynamic Send columns -->
                <th class="send-col" id="send-op-header">Send OP</th>
                <th class="send-col" id="send-tmps-header">+Tmps</th>
                <th class="send-col" id="send-dp-header">Send DP</th>
                <!-- Always visible -->
                <th>Temples</th>
                <th>Paid</th>
                <!-- Optional columns -->
                <th class="col-draftees">Draftees</th>
                <th class="col-boats">Boats (#/prt)</th>
                <th class="col-boats">Sendable (#/cap)</th>
                <th class="col-basic">Raw OP</th>
                <th class="col-basic">Raw DP</th>
                <!-- Always visible -->
                <th>NW</th>
            </tr>
        </thead>
        {% for dom in doms %}
        <tr>
            <td>
                <a href="{{ url_for('dominfo', domcode=dom.code) }}">{{ dom.name }}</a>
            </td>
            <td>{{ dom.realm }}</td>
            <td>
                <a href="{{ url_for('military', versus_op=dom.five_over_four_op) }}">
                    {{ dom.race }}
                </a>
            </td>
            <td  {% if 1 < dom.ops_age <= 12 %}class="stale"{% elif dom.ops_age > 12 %}class="invalid"{% endif %}>
                {{ dom.ops_age }}{% if dom.has_incomplete_intel %} !{% endif %}
            </td>
            <td>{{ dom.land }}</td>
            <td>{{ dom.hittable_75_percent }}</td>
            <!-- Dynamic Send columns -->
            <td class="send-col send-op" data-safe="{{ dom.safe_op }}" data-54="{{ dom.five_over_four_op }}">{{ dom.safe_op }}</td>
            <td class="send-col send-tmps" data-safe="{{ dom.safe_op_with_temples }}" data-54="{{ dom.five_four_op_with_temples }}">{{ dom.safe_op_with_temples }}</td>
            <td class="send-col send-dp" data-safe="{{ dom.safe_dp }}" data-54="{{ dom.five_over_four_dp }}">{{ dom.safe_dp }}</td>
            <!-- Always visible -->
            <td>{{ (dom.temples * 100)|round(1) }}%</td>
            <td>{{ dom.paid_until }}</td>
            <!-- Optional columns -->
            <td class="col-draftees">{{ dom.draftees }}</td>
            <td class="col-boats">{{ dom.boats_amount }}/{{ dom.boats_prt }}</td>
            <td class="col-boats">{{ dom.boats_sendable }}/{{ dom.boats_capacity }}</td>
            <td class="col-basic" title="Raw {{ dom.raw_op }}">{{ dom.op }}</td>
            <td class="col-basic" title="Raw {{ dom.raw_dp }}">{{ dom.dp }}</td>
            <!-- Always visible -->
            <td>{{ dom.networth }}</td>
        </tr>
        {% endfor %}
        </table>
    </div><br>
  </div>

<script>
    var militaryTable;

    function updateSendType() {
        const preset = $('input[name="send_type"]:checked').val();

        // Update column headers based on mode
        if (preset === '54') {
            $('#send-op-header').text('5/4 OP');
            $('#send-dp-header').text('5/4 DP');
        } else {
            $('#send-op-header').text('Send OP');
            $('#send-dp-header').text('Send DP');
        }

        // Update cell values based on mode
        $('.send-col').each(function() {
            const val = $(this).data(preset);
            if (val !== undefined) {
                $(this).text(val);
            }
        });

        // Invalidate DataTable cache and redraw
        if (militaryTable) {
            militaryTable.rows().invalidate('dom').draw();
        }
    }

    $(document).ready(function() {
        // Initialize DataTable with ColVis and ColReorder
        militaryTable = $('#military_table').DataTable({
            paging: false,
            order: [[7, 'desc']], // Sort by +Tmps column by default
            columnDefs: [
                { type: "num", targets: [1, 3, 4, 5, 6, 7, 8, 11, 12, 13, 14, 15, 16] },
                { visible: false, targets: [11, 12, 13, 14, 15] } // Hide Draftees, Boats, Raw OP/DP by default
            ],
            autoWidth: false,
            colReorder: true,
            stateSave: true,
            stateDuration: -1, // Use localStorage (persists across sessions)
            buttons: [
                {
                    extend: 'colvis',
                    text: 'Columns â–¼',
                    columns: ':not(:first-child)' // All except Dominion
                }
            ]
        });

        // Move the Columns button to our container
        militaryTable.buttons().container().appendTo('#colvis-container');

        // Column indices for quick toggles
        const drafteesCols = [11];
        const boatsCols = [12, 13];

        // Sync checkboxes with current column visibility
        function syncCheckboxes() {
            $('#toggle-draftees').prop('checked', militaryTable.column(11).visible());
            $('#toggle-boats').prop('checked', militaryTable.column(12).visible());
        }
        syncCheckboxes();

        // Handle Draftees checkbox
        $('#toggle-draftees').on('change', function() {
            const visible = $(this).is(':checked');
            drafteesCols.forEach(idx => militaryTable.column(idx).visible(visible));
        });

        // Handle Boats checkbox
        $('#toggle-boats').on('change', function() {
            const visible = $(this).is(':checked');
            boatsCols.forEach(idx => militaryTable.column(idx).visible(visible));
        });

        // Sync checkboxes when ColVis dropdown changes visibility
        militaryTable.on('column-visibility.dt', function() {
            syncCheckboxes();
        });

        // Handle radio button changes for Send Type
        $('input[name="send_type"]').on('change', function() {
            updateSendType();
        });

        // Reset to defaults
        $('#reset-columns').on('click', function(e) {
            e.preventDefault();
            militaryTable.state.clear();
            location.reload();
        });

        // Handle VS OP input
        $('#versus-op').on('change', function() {
            const val = $(this).val();
            if (val && val > 0) {
                window.location.href = '{{ url_for("military") }}?versus_op=' + val;
            } else {
                window.location.href = '{{ url_for("military") }}';
            }
        });
    });
</script>
{% endblock %}