{% extends "odinfo-base.html" %}
{% block extrascripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.css" />
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.js"></script>
{% endblock %}

{% block content %}
  <div class="w3-container">
    <h5>Military {% if versus_op != 0 %}(VERSUS {{ versus_op }} OP){% endif %}</h5>
    {% if top_op %}
        <p><b>Top OP is {{ top_op.name }} (#{{ top_op.realm }}) with {{ top_op.five_over_four_op }} OP and
            {{ (top_op.temples * 100)|round(1) }}% Temples, in {{ top_op.paid_until }} ticks.
        </b></p>
    {% endif %}
    
    <!-- Column View Selector -->
    <div class="w3-panel w3-card-2 w3-dark-grey" style="margin-bottom: 10px; padding: 8px;">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <span><strong>Send Type:</strong></span>
            <label style="cursor: pointer;">
                <input type="radio" name="send_type" value="safe" checked> Normal Send
            </label>
            <label style="cursor: pointer;">
                <input type="radio" name="send_type" value="54"> 5/4 Send
            </label>
            <span style="margin-left: 20px;"><strong>Show:</strong></span>
            <label style="cursor: pointer;">
                <input type="checkbox" class="column-toggle" data-group="boats"> Boats
            </label>
            <label style="cursor: pointer;">
                <input type="checkbox" class="column-toggle" data-group="basic"> Raw OP/DP
            </label>
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table id="military_table" class="w3-table w3-striped w3-bordered w3-border w3-hoverable w3-white" style="min-width: 100%; white-space: nowrap;">
        <thead>
            <tr class="w3-black">
                <!-- Always visible -->
                <th>Dominion</th>
                <th>Realm</th>
                <th>Race</th>
                <th>Ops Age</th>
                <th>Land</th>
                <th>75%</th>
                <!-- Dynamic Send columns -->
                <th class="send-col" id="send-op-header">Send OP</th>
                <th class="send-col" id="send-tmps-header">+Tmps</th>
                <th class="send-col" id="send-dp-header">Send DP</th>
                <!-- Always visible -->
                <th>Temples</th>
                <th>Paid</th>
                <!-- Optional columns -->
                <th class="col-boats">Boats (#/prt)</th>
                <th class="col-boats">Sendable (#/cap)</th>
                <th class="col-basic">Raw OP</th>
                <th class="col-basic">Raw DP</th>
                <!-- Always visible -->
                <th>NW</th>
            </tr>
        </thead>
        {% for dom in doms %}
        <tr>
            <td>
                <a href="{{ url_for('dominfo', domcode=dom.code) }}">{{ dom.name }}</a>
            </td>
            <td>{{ dom.realm }}</td>
            <td>
                <a href="{{ url_for('military', versus_op=dom.five_over_four_op) }}">
                    {{ dom.race }}
                </a>
            </td>
            <td  {% if 1 < dom.ops_age <= 12 %}class="stale"{% elif dom.ops_age > 12 %}class="invalid"{% endif %}>
                {{ dom.ops_age }}
            </td>
            <td>{{ dom.land }}</td>
            <td>{{ dom.hittable_75_percent }}</td>
            <!-- Dynamic Send columns -->
            <td class="send-col send-op" data-safe="{{ dom.safe_op }}" data-54="{{ dom.five_over_four_op }}">{{ dom.safe_op }}</td>
            <td class="send-col send-tmps" data-safe="{{ dom.safe_op_with_temples }}" data-54="{{ dom.five_four_op_with_temples }}">{{ dom.safe_op_with_temples }}</td>
            <td class="send-col send-dp" data-safe="{{ dom.safe_dp }}" data-54="{{ dom.five_over_four_dp }}">{{ dom.safe_dp }}</td>
            <!-- Always visible -->
            <td>{{ (dom.temples * 100)|round(1) }}%</td>
            <td>{{ dom.paid_until }}</td>
            <!-- Optional columns -->
            <td class="col-boats">{{ dom.boats_amount }}/{{ dom.boats_prt }}</td>
            <td class="col-boats">{{ dom.boats_sendable }}/{{ dom.boats_capacity }}</td>
            <td class="col-basic" title="Raw {{ dom.raw_op }}">{{ dom.op }}</td>
            <td class="col-basic" title="Raw {{ dom.raw_dp }}">{{ dom.dp }}</td>
            <!-- Always visible -->
            <td>{{ dom.networth }}</td>
        </tr>
        {% endfor %}
        </table>
    </div><br>
  </div>

<script>
    var militaryTable;
    
    // Column indices for DataTable (0-based)
    const columnGroups = {
        'send': [6, 7, 8],    // Send OP, +Tmps, Send DP
        'boats': [11, 12],    // Boats, Sendable
        'basic': [13, 14]     // Raw OP, DP
    };
    
    function loadColumnPreferences() {
        const saved = localStorage.getItem('military_columns');
        if (saved) {
            return JSON.parse(saved);
        }
        // Default: show Safe/Normal columns only
        return { preset: 'safe', toggles: {} };
    }
    
    function saveColumnPreferences(preset, toggles) {
        localStorage.setItem('military_columns', JSON.stringify({ preset, toggles }));
    }
    
    function updateColumnVisibility() {
        const preset = $('input[name="send_type"]:checked').val();
        
        // Update column headers based on mode (keep +Tmps constant)
        if (preset === '54') {
            $('#send-op-header').text('5/4 OP');
            $('#send-dp-header').text('5/4 DP');
        } else {
            $('#send-op-header').text('Send OP');
            $('#send-dp-header').text('Send DP');
        }
        
        // Update cell values based on mode
        $('.send-col').each(function() {
            const val = $(this).data(preset);
            if (val !== undefined) {
                $(this).text(val);
            }
        });
        
        // Handle optional columns based on checkboxes
        $('.column-toggle').each(function() {
            const group = $(this).data('group');
            const isChecked = $(this).is(':checked');
            
            if (columnGroups[group] && militaryTable) {
                columnGroups[group].forEach(idx => {
                    militaryTable.column(idx).visible(isChecked);
                });
            }
        });
        
        // Invalidate DataTable cache and re-sort
        if (militaryTable) {
            // Tell DataTable that the data has changed
            militaryTable.rows().invalidate('dom');
            // Re-sort by +Tmps column (column 7) after data update
            militaryTable.order([7, 'desc']).draw();
        }
    }
    
    $(document).ready(function() {
        // Load preferences
        const prefs = loadColumnPreferences();
        
        // Set initial radio button state - force safe as default
        $('input[name="send_type"][value="safe"]').prop('checked', true);
        
        // Set initial checkbox states
        Object.keys(prefs.toggles || {}).forEach(group => {
            if (prefs.toggles[group]) {
                $('.column-toggle[data-group="' + group + '"]').prop('checked', true);
            }
        });
        
        // Initialize DataTable with all columns visible initially
        militaryTable = $('#military_table').DataTable({
            'paging': false,
            'order': [[7, 'desc']], // Sort by +Tmps column by default
            'columnDefs': [
                { "type": "num", "targets": [1, 3, 4, 5, 6, 7, 8, 11, 12, 13, 14, 15]}
            ],
            'autoWidth': false,
            'scrollX': true
        });
        
        // Apply initial visibility after DataTable is ready
        setTimeout(function() {
            updateColumnVisibility();
        }, 100);
        
        // Handle radio button changes
        $('input[name="send_type"]').on('change', function() {
            console.log('Radio button changed to:', $(this).val());
            updateColumnVisibility();
            
            // Save preferences
            const preset = $(this).val();
            const toggles = {};
            $('.column-toggle').each(function() {
                toggles[$(this).data('group')] = $(this).is(':checked');
            });
            saveColumnPreferences(preset, toggles);
        });
        
        // Handle checkbox changes
        $('.column-toggle').on('change', function() {
            console.log('Checkbox changed:', $(this).data('group'), $(this).is(':checked'));
            updateColumnVisibility();
            
            // Save preferences
            const preset = $('input[name="send_type"]:checked').val();
            const toggles = {};
            $('.column-toggle').each(function() {
                toggles[$(this).data('group')] = $(this).is(':checked');
            });
            saveColumnPreferences(preset, toggles);
        });
    });
</script>
{% endblock %}